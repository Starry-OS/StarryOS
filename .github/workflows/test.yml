name: Build and Test

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  harness:
    name: Harness CI (aarch64)
    runs-on: ubuntu-latest

    env:
      ARCH: aarch64
      STARRYOS_REMOTE: https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git
      STARRYOS_COMMIT: ${{ github.event.pull_request.head.sha || github.sha }}
      RUSTUP_TOOLCHAIN: nightly-2025-05-20

    steps:
      - name: Checkout StarryOS (current PR)
        uses: actions/checkout@v4
        with:
          path: StarryOS
          submodules: recursive

      - name: Checkout Test Harness
        uses: actions/checkout@v4
        with:
          repository: kylin-x-kernel/starry-test-harness
          path: starry-test-harness

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: nightly-2025-05-20
          components: rustfmt,clippy,llvm-tools-preview,rust-src
          targets: aarch64-unknown-none-softfloat

      - name: Cache rootfs template
        uses: actions/cache@v3
        with:
          path: starry-test-harness/.cache/rootfs
          key: rootfs-${{ env.ARCH }}-20250917


      - name: Setup QEMU
        uses: arceos-org/setup-qemu@v1
        with:
          version: 10.1.0
          arch_list: ${{ env.ARCH }}

      
      - uses: arceos-org/setup-musl@v1
        with:
          arch: ${{ env.ARCH }}

      - run: sudo apt-get update && sudo apt-get install -y e2fsprogs

      - name: Run test harness ci-test
        working-directory: starry-test-harness
        env:
          ARCH: ${{ env.ARCH }}
          STARRYOS_REMOTE: ${{ env.STARRYOS_REMOTE }}
          STARRYOS_COMMIT: ${{ env.STARRYOS_COMMIT }}
          STARRYOS_ROOT: ${{ github.workspace }}/starry-test-harness/.cache/StarryOS
          ROOTFS_CACHE_DIR: ${{ github.workspace }}/starry-test-harness/.cache/rootfs
          SKIP_STARRY_BUILD: ${{ env.SKIP_STARRY_BUILD }}
          CC_aarch64_unknown_linux_musl: aarch64-linux-musl-gcc
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: aarch64-linux-musl-gcc
        run: make ci-test run

      - name: Upload harness logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: harness-logs-${{ github.run_id }}
          path: starry-test-harness/logs/**
          if-no-files-found: warn